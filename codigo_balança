#include <stdio.h>
#include <locale.h>
#include <string.h>
#include <stdlib.h> 
#include <ctype.h>

// Estrutura para armazenar código, nome, valor e tipo de venda (quilo ou granel)
struct Produto {
    int codigo_produto, tipo_produto;
    char nome_produto[30];
    float valor;
};

// Array para armazenar os produtos
struct Produto listaDeProdutos[100];
int totalProdutos = 0;

// Função para limpar a tela
void limparTela() {
    #ifdef _WIN32
        system("cls");   // Comando para limpar a tela no Windows
    #else
        system("clear"); // Comando para limpar a tela no Linux ou macOS
    #endif
}

// Função para limpar o buffer de entrada
void limparBuffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

// Função para ler e validar um número inteiro
int lerInteiro() {
    int numero;
    char c;

    while (1) {
        if (scanf("%d", &numero) == 1) {
            limparBuffer();
            return numero;
        } else {
            limparBuffer();
            printf("Entrada inválida! Por favor, digite uma opção válida: ");
        }
    }
}

// Função para ler e validar um valor real
float lerValorReal() {
    float valor;
    char c; 
    while (1) {
        if (scanf("%f", &valor) == 1) {
            limparBuffer();  
            return valor;   
        } else {
            limparBuffer(); 
            printf("Entrada inválida! Por favor, digite um valor real:\n");
        }
    }
}

// Função para ler apenas letras
void lerNomeProduto(char *nome) {
    while (1) {
        printf("Digite o nome do produto: ");
        fgets(nome, 30, stdin);
        
        // Remove o caractere de nova linha se presente
        nome[strcspn(nome, "\n")] = 0;

        // Verifica se o nome contém apenas letras e espaços
        int valido = 1; // Assume que é válido
        for (int i = 0; nome[i] != '\0'; i++) {
            if (!isalpha(nome[i]) && nome[i] != ' ') { // Aceita apenas letras e espaços
                valido = 0; // Não é válido
                break;
            }
        }

        if (valido) {
            break; // Nome válido, sai do loop
        } else {
            printf("Entrada inválida! O nome do produto deve conter apenas letras.\n");
        }
    }
}

// Função para verificar se um código de produto já existe
int codigoExiste(int codigo) {
    for (int i = 0; i < totalProdutos; i++) {
        if (listaDeProdutos[i].codigo_produto == codigo) {
            return 1;
        }
    }
    return 0;
}

// Inicialização dos produtos
void inicializarProdutos() {
    listaDeProdutos[0].codigo_produto = 1;
    strcpy(listaDeProdutos[0].nome_produto, "Manga");
    listaDeProdutos[0].valor = 7.99;
    listaDeProdutos[0].tipo_produto = 1;

    listaDeProdutos[1].codigo_produto = 2;
    strcpy(listaDeProdutos[1].nome_produto, "Banana");
    listaDeProdutos[1].valor = 5.99;
    listaDeProdutos[1].tipo_produto = 1;

    listaDeProdutos[2].codigo_produto = 3;
    strcpy(listaDeProdutos[2].nome_produto, "Castanha");
    listaDeProdutos[2].valor = 13.99;
    listaDeProdutos[2].tipo_produto = 2;
    
    listaDeProdutos[3].codigo_produto = 4;
    strcpy(listaDeProdutos[3].nome_produto, "Amendoim");
    listaDeProdutos[3].valor = 12.99;
    listaDeProdutos[3].tipo_produto = 2;

    totalProdutos = 4;
}

// Função para listar os produtos
void listarProdutos() {
    printf("\n\n------------ LISTA DE PRODUTOS -------------\n");

    printf("Produtos por QUILO:\n");
    printf("Código \t Produto \t Valor (R$/Kg)\n");
    for (int i = 0; i < totalProdutos; i++) {
        if (listaDeProdutos[i].tipo_produto == 1) {
            printf("%03d\t %-10s\t R$ %.2f\n", listaDeProdutos[i].codigo_produto, listaDeProdutos[i].nome_produto, listaDeProdutos[i].valor);
        }
    }
    
    printf("\nProdutos por GRANEL:\n");
    printf("Código \t Produto \t Valor (R$/Unidade)\n");
    for (int i = 0; i < totalProdutos; i++) {
        if (listaDeProdutos[i].tipo_produto == 2) {
            printf("%03d\t %-10s\t R$ %.2f\n", listaDeProdutos[i].codigo_produto, listaDeProdutos[i].nome_produto, listaDeProdutos[i].valor);
        }
    }
    
    printf("--------------------------------------------\n");
}

// Função para cadastrar um novo produto
void cadastrarProduto() {
    if (totalProdutos < 100) {
        int opcao_cadastrarMais;
        int codigo;
        
        printf("\n\n------------ CADASTRAR PRODUTO -------------\n");
        
        // Verifica se o código já existe
        do {
            printf("Digite o código do novo produto: ");
            codigo = lerInteiro();
            
            if (codigoExiste(codigo)) {
                printf("Código existente! Por favor, insira um código diferente.\n");
            }
        } while (codigoExiste(codigo));

        // Quando o código for válido, armazena o produto
        listaDeProdutos[totalProdutos].codigo_produto = codigo;

        lerNomeProduto(listaDeProdutos[totalProdutos].nome_produto);
        
        printf("Digite o valor do produto (R$) (utilize .): ");
        listaDeProdutos[totalProdutos].valor = lerValorReal();
        
        printf("O produto será vendido por quilo ou granel?:\n");
        printf("1. Quilo\n");
        printf("2. Granel\n");
        printf("Informe uma opção válida e aperte a tecla enter: ");
        
        int opcao = lerInteiro();

        if (opcao == 1 || opcao == 2) {
            listaDeProdutos[totalProdutos].tipo_produto = opcao;
            totalProdutos++;
            printf("Produto cadastrado com sucesso!\n\n");
        } else {
            printf("Opção inválida! Produto não cadastrado.\n");
        }

        // Pergunta se o usuário deseja cadastrar mais algum produto
        char continuar;
        printf("Deseja cadastrar mais algum produto?\nDigite 's' para Sim e 'n' para Não (s/n): ");
        scanf(" %c", &continuar);
        limparBuffer();
        if (continuar == 's' || continuar == 'S') {
            cadastrarProduto(); // Recursão para cadastrar outro produto
        }
    
    } else {
        printf("Limite de produtos atingido!\n");
    }
}

// Função para excluir um produto
void excluirProduto() {
    int codigo_produto;

    printf("\n\n------------- EXCLUIR PRODUTO --------------\n");
    while (1) {
        printf("Digite o código do produto que deseja excluir: ");
        codigo_produto = lerInteiro();

        int encontrado = 0;
        for (int i = 0; i < totalProdutos; i++) {
            if (listaDeProdutos[i].codigo_produto == codigo_produto) {
                encontrado = 1;
                // Pergunta confirmação
                printf("Tem certeza que deseja excluir o produto '%s'? \n\nDigite 's' para Sim e 'n' para Não (s/n): ", listaDeProdutos[i].nome_produto);
                char confirmar;
                confirmar = getchar();
                limparBuffer(); 

                if (confirmar == 's' || confirmar == 'S') {
                    for (int j = i; j < totalProdutos - 1; j++) {
                        listaDeProdutos[j] = listaDeProdutos[j + 1];
                    }
                    totalProdutos--;
                    printf("Produto com código %d excluído com sucesso!\n\n", codigo_produto);
                } else {
                    printf("Exclusão cancelada.\n");
                }
                break;
            }
        }

        if (!encontrado) {
            printf("Produto com código %d não encontrado.\n", codigo_produto);
        }

        // Pergunta se deseja excluir mais algum produto
        printf("\nDeseja excluir mais algum produto?\nDigite 's' para Sim e 'n' para Não (s/n): ");
        char continuar;
        continuar = getchar();
        limparBuffer();

        if (continuar != 's' && continuar != 'S') {
            break; 
        }
    }
} 

// Função para calcular o preço com base no tipo (quilo ou granel)
void calcularPreco() {
    int codigo;
    char continuar;
    float totalCompra = 0;  // Variável para armazenar o total da compra

    do {
        printf("\n\n-------------- CALCULAR PREÇO --------------\n");
        printf("Digite o código do produto que deseja calcular o valor: ");
        codigo = lerInteiro(); // Lê o código inserido pelo usuário
        
        int encontrado = 0; // Variável que verifica se o produto foi encontrado
        for (int i = 0; i < totalProdutos; i++) {
            if (listaDeProdutos[i].codigo_produto == codigo) {
                encontrado = 1;
                
                // Verifica se o produto é vendido por quilo
                if (listaDeProdutos[i].tipo_produto == 1) {
                    float peso;
                    printf("Digite o peso em quilos: ");
                    peso = lerValorReal(); // Lê o peso inserido pelo usuário
                    // Calcula e exibe o valor total baseado no peso
                    float valorProduto = listaDeProdutos[i].valor * peso;
                    printf("O valor total do produto %s é: R$ %.2f\n", listaDeProdutos[i].nome_produto, valorProduto);
                    totalCompra += valorProduto; // Soma o valor ao total da compra
                    
                // Caso contrário, o produto é vendido por unidade
                } else {
                    int quantidade;
                    printf("Digite a quantidade (unidades): ");
                    quantidade = lerInteiro(); // Lê a quantidade inserida pelo usuário
                    // Calcula e exibe o valor total baseado na quantidade
                    float valorProduto = listaDeProdutos[i].valor * quantidade;
                    printf("O valor total do produto %s é: R$ %.2f\n", listaDeProdutos[i].nome_produto, valorProduto);
                    totalCompra += valorProduto;  / Soma o valor ao total da compra
                }
                break; // Encerra o loop ao encontrar o produto
            }
        }
        
        if (!encontrado) { // Caso o produto não seja encontrado na lista
            printf("Produto com código %d não encontrado.\n", codigo);
        }

        // Pergunta ao usuário se deseja calcular o preço de outro produto
        printf("\nDeseja calcular o preço de outro produto?\nDigite 's' para Sim e 'n' para Não (s/n): ");
        scanf(" %c", &continuar); // Lê a escolha do usuário
        limparBuffer(); // Limpa o buffer de entrada para evitar erros na próxima leitura

    } while (continuar == 's' || continuar == 'S'); // Continua se o usuário digitar 's' ou 'S'
    
    // Exibir o total da compra ao final
    printf("\nO valor total da compra é: R$ %.2f\n", totalCompra);
}

// Função principal
int main() {
setlocale(LC_ALL, "Portuguese");
    int opcao;

    inicializarProdutos();

    do {
      
        
        printf("------------------- MENU -------------------\n");
        printf("1. Listar Produtos\n");
        printf("2. Cadastrar Produto\n");
        printf("3. Excluir Produto\n");
        printf("4. Calcular Compra\n");
        printf("5. Sair do Programa\n");
        printf("Digite a opção desejada: ");
        
        opcao = lerInteiro();

        switch (opcao) {
            case 1:
                listarProdutos();
                break;
            case 2:
                cadastrarProduto();
                break;
            case 3:
                excluirProduto();
                break;
            case 4:
                calcularPreco();
                break;
            case 5:
                printf("Saindo do programa...\n");
                break;
            default:
                printf("Opção inválida! Por favor, digite uma opção válida.\n");
                break;
        }
    } while (opcao != 5);

    return 0;
}
